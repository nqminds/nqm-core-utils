!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("debug"),require("shortid"),require("mongo-parse")):"function"==typeof define&&define.amd?define("nqm-core-utils",["_","debug","shortid","mongo-parse"],t):"object"==typeof exports?exports["nqm-core-utils"]=t(require("lodash"),require("debug"),require("shortid"),require("mongo-parse")):e["nqm-core-utils"]=t(e._,e.debug,e.shortid,e["mongo-parse"])}(this,function(e,t,o,a){return function(e){function t(a){if(o[a])return o[a].exports;var r=o[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var o={};return t.m=e,t.c=o,t.i=function(e){return e},t.d=function(e,o,a){t.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:a})},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=10)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={readAccess:"r",writeAccess:"w",publicRWShareMode:"pw",publicROShareMode:"pr",trustedShareMode:"tr",resourceEventType:"Resource",accountEventType:"Account",mongooseTypes:{string:1,number:1,date:1,boolean:1},vocabularyResourceType:"vocabulary",schemaResourceType:"schema",datasetResourceType:"dataset",visualisationResourceType:"visualisation",groupResourceType:"resourceGroup",rootGroupResourceType:"rootGroup",rawFileResourceType:"rawFile",applicationBaseType:"applicationBase",applicationDefinitionResourceType:"applicationDefinition",databotBaseType:"databot",databotDefinitionResourceType:"databotDefinition",databotHostResourceType:"databotHost",accountSetBaseType:"accountSetBase",accountSetResourceType:"accountSet",resourceRootGroupResourceType:"resourceRootGroup",scratchGroupResourceType:"scratchGroup",datasetFilterResourceType:"datasetFilter",geojsonResourceType:"geojson",widgetVisualisationResourceType:"widgetVisualisation",timeSeriesVisualisationResourceType:"timeSeriesVisualisation",mapVisualisationResourceType:"mapVisualisation",statusVisualisationResourceType:"statusVisualisation",databotRootGroupResourceType:"databotRootGroup",databotDefinitionGroupResourceType:"databotGroup",databotHostGroupResourceType:"databotHostGroup",databotInstanceGroupResourceType:"databotInstanceGroup",databotActiveHostGroupResourceType:"databotActiveHostGroup",databotControllerResourceType:"databotController",applicationRootGroupResourceType:"applicationRootGroup",applicationDefinitionGroupResourceType:"applicationDefinitionGroup",applicationServerGroupResourceType:"applicationServerGroup",applicationDataGroupResourceType:"applicationDataGroup",accountSetRootGroupResourceType:"accountSetRootGroup",accountSetGroupResourceType:"accountSetGroup",databotInstancesResourceType:"databotInstances",databotInstanceOutputResourceType:"databotInstanceOutput",databotProcessesResourceType:"databotProcesses",activeDatabotHostsResourceType:"activeDatabotHosts",userAccountType:"user",tokenAccountType:"token",hostAccountType:"host",applicationAccountType:"application",accountSetAccountType:"accountSet",schemasResourceId:"__schemas__",vocabularyResourceId:"__vocab__",npmDatabotType:"npm",inlineDatabotType:"script",zipDatabotType:"zip",githubDatabotType:"github",urlDatabotType:"url",browserHostType:"browser",serverHostType:"server",databotInstancesResourceId:"__databotInstances__",databotInstanceOutputResourceId:"__databotInstanceOutput__",databotProcessesResourceId:"__databotProcesses__",activeDatabotHostsResourceId:"__activeDatabotHosts__",unallocatedDatabotStatus:"unallocated",pendingDatabotStatus:"pending",installingDatabotStatus:"installing",partRunningDatabotStatus:"partRunning",runningDatabotStatus:"running",pausedDatabotStatus:"paused",stoppingDatabotStatus:"stopping",completeDatabotStatus:"complete",errorDatabotStatus:"error",immediateDatabotInstanceRunMode:"run-now",alwaysDatabotInstanceRunMode:"run-always",scheduledDatabotInstanceRunMode:"scheduled",pauseDatabotInstance:"pause",resumeDatabotInstance:"resume",stopDatabotInstance:"stop",datasetImportDatabot:"__datasetImport__",datasetCopyDatabot:"__datasetCopy__",onlineHostStatus:"online",offlineHostStatus:"offline",idleHostStatus:"idle",busyHostStatus:"busy",errorHostStatus:"error",resourceVocabularyId:"ResourceId",datasetVocabularyId:"DatasetId",folderVocabularyId:"FolderId",rawFileVocabularyId:"RawFileId",visualisationVocabularyId:"VisualisationId",schemaVocabularyId:"SchemaId",databotDefinitionVocabularyId:"DatabotDefinitionId",urlVocabularyId:"Url",builtIndexStatus:"built",pendingIndexStatus:"pending",suspendingIndexStatus:"suspending",suspendedIndexStatus:"suspended",errorIndexStatus:"error",githubAuthService:"oauth:github",googleAuthService:"oauth:google",localAuthService:"local",guestAccount:"...guest...",maxTimestamp:864e13,datasetStorePrefix:"dataset.",rootFolderPrefix:"r.",rootFolderName:"root",scratchFolderPrefix:"s.",scratchFolderName:"scratch",scratchFolderAlias:"__scratch__",resourceRootFolderPrefix:"rs.",resourceRootFolderName:"resources",accountSetRootFolderPrefix:"ug.",accountSetRootFolderName:"user groups",applicationRootFolderPrefix:"a.",applicationRootFolderName:"applications",applicationDefinitionFolderPrefix:"adef.",applicationDefinitionFolderName:"application definitions",applicationServerFolderPrefix:"as.",applicationServerFolderName:"application servers",applicationDataFolderPrefix:"ad.",applicationDataFolderName:"authorised applications",applicationServerDataFolderPrefix:"adat.",databotRootFolderPrefix:"dbr.",databotRootFolderName:"databots",databotDefinitionFolderPrefix:"db.",databotDefinitionFolderName:"databot definitions",databotHostFolderPrefix:"dh.",databotHostFolderName:"databot hosts",databotInstanceFolderPrefix:"dbi.",databotInstanceFolderName:"databot instances",databotActiveHostFolderPrefix:"dah.",databotActiveHostFolderName:"active databot hosts",readOnlyOwnershipMode:"read-only",userOwnershipMode:"user",appOwnershipMode:"application",impersonateAccessMode:"impersonate",shareAccessMode:"shared",identityFilterPlaceholder:"@@_identity_@@",authenticateApplicationId:"__authenticate__",toolboxApplicationId:"__toolbox__"},e.exports=t.default},function(t,o){t.exports=e},function(e,t,o){"use strict";function a(e){var t=0;if(0==e.length)return t;for(var o=0;o<e.length;o++){t=(t<<5)-t+e.charCodeAt(o),t&=t}return t}function r(e,t){function o(e){return"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[e]}t=t||62;var a,r=[],n="",u=e<0?"-":"";for(e=Math.abs(e);e>=t;)a=e%t,e=Math.floor(e/t),r.push(o(a));e>0&&r.push(o(e));for(var i=r.length-1;i>=0;i--)n+=r[i];return u+n}function n(e){return r(a(e),61).replace("-","Z")}Object.defineProperty(t,"__esModule",{value:!0}),t.default={bitwise:a,binaryTransfer:r,unique:n},e.exports=t.default},function(e,o){e.exports=t},function(e,t,o){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=o(3),n=a(r),u=o(11),i=a(u),s=o(1),c=a(s),d=(0,n.default)("nqm-core-utils:build-data-key"),l=function(e,t,o){var a={};return c.default.forEach(e,function(e){var r=e.asc||e.desc,n=i.default.DotNotationPointers(t,r);if(0===n.length||void 0===n[0].val){if(d("no key data for field '%s' in %j",r,t),o)throw new Error("buildDataKey - incomplete primary key: no data for '"+r+"' in "+JSON.stringify(t))}else a[r]=n[0].val}),a};t.default=l,e.exports=t.default},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=o(0),r=function(e){return e&&e.__esModule?e:{default:e}}(a),n=function(e){return e&&(e.status===r.default.runningDatabotStatus||e.status===r.default.installingDatabotStatus||e.status===r.default.partRunningDatabotStatus||e.status===r.default.pausedDatabotStatus)};t.default={isDatabotInstanceRunning:n},e.exports=t.default},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(e,a){if(Object(e)!==e)o[a]=e;else if(Array.isArray(e)){for(var r=e.length,n=0;n<r;n++)t(e[n],a+"."+n);0===r&&(o[a]=[])}else{var u=!0;for(var i in e)u=!1,t(e[i],a?a+"."+i:i);u&&a&&(o[a]={})}}var o={};return t(e,""),o};t.default=a,e.exports=t.default},function(e,t,o){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=o(0),n=a(r),u=o(1),i=a(u),s=o(2),c=a(s),d=[n.default.datasetResourceType,n.default.groupResourceType,n.default.rawFileResourceType],l=function(e,t){return t=[].concat(t),e=e||{},e.schemaDefinition?t.indexOf(e.schemaDefinition.id)>=0||i.default.intersection(e.schemaDefinition.basedOn||[],t).length>0:t.indexOf(e.baseType)>=0},p=function(e){var t=void 0;switch(e){case n.default.groupResourceType:t="folder";break;case n.default.rawFileResourceType:t="raw file";break;case n.default.widgetVisualisationResourceType:t="widget visualisation";break;case n.default.timeSeriesVisualisationResourceType:t="time series visualisation";break;case n.default.mapVisualisationResourceType:t="map visualisation";break;case n.default.statusVisualisationResourceType:t="status visualisation";break;case n.default.scheduledTasksResourceType:t="scheduled tasks";break;case n.default.processHostsResourceType:t="process hosts";break;default:t=e}return t},f=function(e){var t=void 0;switch(e){case n.default.publicRWShareMode:t="public view and edit";break;case n.default.publicROShareMode:t="public view, trusted edit";break;case n.default.trustedShareMode:t="trusted only";break;default:t="!!unknown!!"}return t},y=function(e,t){var o={};return i.default.forEach(e.schemaDefinition.uniqueIndex,function(e){var a=e.asc||e.desc;o[a]=t[a]}),o},b=function(e){return C(n.default.rootFolderPrefix,e)},R=function(e){return C(n.default.resourceRootFolderPrefix,e)},h=function(e){return C(n.default.applicationRootFolderPrefix,e)},m=function(e){return C(n.default.applicationDefinitionFolderPrefix,e)},T=function(e){return C(n.default.applicationDataFolderPrefix,e)},_=function(e){return C(n.default.databotRootFolderPrefix,e)},v=function(e){return C(n.default.accountSetRootFolderPrefix,e)},g=function(e,t){var o=void 0;switch(t){case n.default.datasetResourceType:o=R(e);break;case n.default.applicationBaseType:o=h(e);break;case n.default.databotBaseType:o=_(e);break;case n.default.accountSetBaseType:o=v(e)}return o},D=function(e){return d.indexOf(e)>=0},x=function(e){return l(e,n.default.accountSetResourceType)},S=function(e){return l(e,n.default.accountSetRootGroupResourceType)},I=function(e){return l(e,n.default.accountSetGroupResourceType)},A=function(e){return l(e,n.default.applicationDefinitionResourceType)},G=function(e){return l(e,n.default.applicationDefinitionGroupResourceType)},F=function(e){return l(e,n.default.databotDefinitionGroupResourceType)},w=function(e){return l(e,n.default.databotHostGroupResourceType)},O=function(e){return l(e,n.default.datasetResourceType)},P=function(e){var t=[n.default.datasetResourceType,n.default.rawFileResourceType];return l(e,t)},j=function(e){return l(e,n.default.geojsonResourceType)},M=function(e){return l(e,n.default.resourceRootGroupResourceType)},N=function(e){return l(e,n.default.schemaResourceType)},k=function(e){return l(e,n.default.scratchGroupResourceType)},q=function(e){return l(e,n.default.vocabularyResourceType)},H=function(e){return e&&e.schemaDefinition&&i.default.isEqual(e.schemaDefinition.basedOn||[],[n.default.groupResourceType])},V=function(e){return l(e,n.default.applicationRootGroupResourceType)||l(e,n.default.databotRootGroupResourceType)||l(e,n.default.databotInstanceGroupResourceType)||l(e,n.default.rootGroupResourceType)},E=function(e){return l(e,n.default.accountSetRootGroupResourceType)||l(e,n.default.applicationRootGroupResourceType)||l(e,n.default.applicationDataGroupResourceType)||l(e,n.default.applicationServerGroupResourceType)||l(e,n.default.databotRootGroupResourceType)||l(e,n.default.databotInstanceGroupResourceType)||l(e,n.default.resourceRootGroupResourceType)||l(e,n.default.rootGroupResourceType)},C=function(e,t){return c.default.unique(e+t)};t.default={getAccountRootId:b,getAccountSetRootId:v,getApplicationRootId:h,getDatabotRootId:_,getApplicationDataId:T,getApplicationDefinitionId:m,getDefaultResourceParent:g,getResourceRootId:R,getResourceTypeText:p,getShareModeText:f,isAccountSet:x,isAccountSetGroup:I,isAccountSetRootGroup:S,isApplicationDefinition:A,isApplicationDefinitionGroup:G,isDatabotDefinitionGroup:F,isDatabotHostGroup:w,isDataset:O,isDatasetOrRawFile:P,isGeoJSON:j,isPlainResourceGroup:H,isPureResource:D,isReadOnlyGroup:V,isReservedGroup:E,isResourceRootGroup:M,isResourceType:l,isSchema:N,isScratchGroup:k,isVocabulary:q,primaryKeyFromFlattened:y,specialFolderId:C},e.exports=t.default},function(e,t,o){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=o(3),u=a(n),i=o(1),s=a(i),c=o(0),d=a(c),l=(0,u.default)("nqm-core-utils:build-data-key"),p=(0,u.default)("nqm-core-utils:build-data-key:error"),f=["_id","prototype","emit","on","once","listeners","removeListener","collection","db","errors","init","isModified","isNew","get","modelName","save","schema","set","toObject","validate","remove","_pres","_posts","__update"],y=function(e,t){var o=s.default.find(e,function(e){return e.id===t});return o&&o.basedOn[0]},b=function(e,t){var o=s.default.find(e,function(e){return e.id===t});return o&&o.basedOn.concat(o.id)},R=function(e,t){var o=[];return t=t||[],Array.isArray(e)?s.default.forEach(e,function(e){"string"==typeof e?o.push({asc:e}):e.asc||e.desc?o.push(e):t.push("invalid index spec: "+JSON.stringify(e))}):"object"===(void 0===e?"undefined":r(e))&&s.default.forEach(e,function(e,t){-1===e?o.push({desc:t}):o.push({asc:t})}),o},h=function(e){var t={};return s.default.forEach(e,function(e){t[e.asc||e.desc]=e.asc?1:-1}),t},m=function(e,t,o){var a=b(e,t);return a||(t=t.toLowerCase(),d.default.mongooseTypes[t]?a=[t]:o.push("invalid base type: "+t)),a},T=function e(t,o,a){return"object"===(void 0===o?"undefined":r(o))?(s.default.forEach(o,function(n,u){"__tdxType"===u?o.__tdxType=[].concat(n):"type"===u?"string"==typeof n?(o.__tdxType=m(t,n,a),delete o.type):Array.isArray(n)?n.length?"object"===r(n[0])?o[u]=e(t,n,a):(m(t,n[0],a),o.__tdxType=n,delete o.type):o[u]=[]:"object"===(void 0===n?"undefined":r(n))?o[u]=e(t,n,a):a.push("invalid schema definition, invalid 'type' spec: "+o):"__tdxRequired"===u||"__tdxDefault"===u||"__tdxDescription"===u||(Array.isArray(n)?1===n.length?n[0]=e(t,n[0],a):n.length?o[u]={__tdxType:n}:o[u]=[]:"object"===(void 0===n?"undefined":r(n))?o[u]=e(t,n,a):"string"==typeof n?o[u]={__tdxType:m(t,n,a)}:a.push("invalid schema definition, unexpected: "+o))}),o):"string"==typeof o?{__tdxType:m(t,o,a)}:void a.push("invalid schema definition, unexpected: "+o)},_=function(e,t,o){var a=void 0;return t=y(e,t)||t,t=t.toLowerCase(),d.default.mongooseTypes[t]?a=s.default.capitalize(t):o.push("invalid base type: "+t),a},v=function e(t,o,a,n){return a=a||[],s.default.each(o,function(u,i){f.indexOf(i)>=0?(p("invalid field name (reserved): %s",i),a.push("invalid field name (reserved): "+i)):"__tdxRequired"===i?(o.required=o.__tdxRequired,delete o.__tdxRequired):"__tdxDefault"===i?(o.default=o.__tdxDefault,delete o.__tdxDefault):"__tdxDescription"===i?(n&&(o.description=o.__tdxDescription),delete o.__tdxDescription):"__tdxType"===i?u?(u=[].concat(u),delete o.__tdxType,o.type=u[0].toLowerCase(),"object"===o.type?o={}:"array"===o.type?o=[]:o.type=_(t,o.type,a)):(p("unexpected __tdxType value: %j",u),a.push("missing __tdxType")):Array.isArray(u)?u.length>1?a.push("invalid array type specification for key: "+i):u.length>0&&("string"==typeof u[0]?o[i]=[{type:_(t,u[0],a)}]:o[i]=[e(t,u[0],a,n)]):"object"===(void 0===u?"undefined":r(u))?o[i]=e(t,u,a,n):"string"!=typeof u?(p("invalid schema definition - unexpected type for key '"+i+"' : "+(void 0===u?"undefined":r(u))),delete o[i]):o[i]={type:_(t,u,a)}}),o},g=function(e,t){var o=t.uniqueIndex,a=t.nonUniqueIndexes,r=[];s.default.forEach(a,function(e){e.length>0&&r.push(h(e))}),l("translated non unique indexes for %s from %j to %j",e,a,r);var n=h(o);l("translated primary index for %s from %j to %j",e,o,n),l("transforming schema for %s: %j",t.id,t.dataSchema);var u=[],i=v(null,t.dataSchema,u,!1);if(u.length)throw new Error("invalid mongoose schema: "+u.join(","));return l("schema transformed to %j",i),{schema:i,uniqueIndex:n,nonUniqueIndexes:r}};t.default={definitionToMongoose:g,schemaToMongoose:function(e,t,o,a){return v(e||[],s.default.cloneDeep(t),o,a)},schemaToTDX:function(e,t,o){return T(e||[],s.default.cloneDeep(t),o)},indexToMongoose:h,indexToTDX:R},e.exports=t.default},function(e,t){e.exports=o},function(e,t,o){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.shortHash=t.unCamelCase=t.splitTDXSchemaId=t.splitTDXResourceId=t.splitTDXAccount=t.slugify=t.shortId=t.schemaUtils=t.resourceUtils=t.parseTDXError=t.parseFunction=t.padNumber=t.makeTDXResourceId=t.makeTDXAccount=t.isNumeric=t.isHostNameValid=t.isDateValid=t.isEmailValid=t.flattenJSON=t.databotUtils=t.constants=t.buildDataKey=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=o(9),u=o(0),i=a(u),s=o(7),c=a(s),d=o(5),l=a(d),p=o(8),f=a(p),y=o(6),b=a(y),R=o(4),h=a(R),m=o(2),T=function(e){return/^[A-Z0-9'.1234z_%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i.test(e)},_=function(e){return/^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/.test(e)},v=function(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())},g=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},D=function(e,t){return e+"/"+t},x=function(e){e.username&&(e=e.username);var t=void 0,o=e.toLowerCase().split("/");return 2===o.length&&T(o[0])&&(_(o[1])||0===o[1].indexOf("localhost:"))&&(t={email:o[0],tdx:o[1]}),t},S=function(e,t){if("object"===(void 0===e?"undefined":r(e))&&(e=e.id),I(e).tdx)return e;if(e&&t)return e+"/"+t.toLowerCase();throw new Error("makeTDXResource: invalid args - must provide resource and tdx")},I=function(e){var t=void 0,o=e.split("/");return 2===o.length?(_(o[1])||0===o[1].indexOf("localhost:"))&&(t={resourceId:o[0],tdx:o[1]}):1===o.length&&(t={resourceId:o[0]}),t},A=function(e){var t=void 0,o=e.split("/");return 2===o.length?t={id:o[0],libraryId:o[1]}:1===o.length&&(t={id:o[0],libraryId:i.default.schemasResourceId}),t},G=function(e,t,o){return o=o||"0",e=""+e,e.length>=t?e:new Array(t-e.length+1).join(o)+e},F=function(e){var t=/function *\(([^()]*)\)[ \n\t]*{(.*)}/gim,o=t.exec(e.replace(/\n/g," "));return o?new Function(o[1].split(","),o[2]):null},w=function(e){var t=void 0;if(e&&"TDXApiError"===e.name)try{t=JSON.parse(e.message),t.failure=JSON.parse(t.failure)}catch(e){t=null}return t||(t={from:"exception",code:e.code||"n/a",failure:{code:e.code||"n/a",message:e.message}}),t},O=function(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b([A-Z]+)([A-Z])([a-z])/,"$1 $2$3").replace(/^./,function(e){return e.toUpperCase()})},P=function(e){return e.toString().trim().toLowerCase().replace(/ /g,"-").replace(/([^a-zA-Z0-9\._-]+)/,"")},j=function(){return(0,n.generate)()};t.buildDataKey=h.default,t.constants=i.default,t.databotUtils=l.default,t.flattenJSON=b.default,t.isEmailValid=T,t.isDateValid=v,t.isHostNameValid=_,t.isNumeric=g,t.makeTDXAccount=D,t.makeTDXResourceId=S,t.padNumber=G,t.parseFunction=F,t.parseTDXError=w,t.resourceUtils=c.default,t.schemaUtils=f.default,t.shortId=j,t.slugify=P,t.splitTDXAccount=x,t.splitTDXResourceId=I,t.splitTDXSchemaId=A,t.unCamelCase=O,t.shortHash=m.unique},function(e,t){e.exports=a}])});